Number.prototype.formatCurrency=function(places,symbol,thousand,decimal){places=!isNaN(places=Math.abs(places))?places:2;symbol=symbol!==undefined?symbol:'&#165;';thousand=thousand||',';decimal=decimal||'.';var number=this,negative=number<0?'-':'',i=parseInt(number=Math.abs(+number||0).toFixed(places),10)+'',j=(j=i.length)>3?j%3:0;return symbol+negative+(j?i.substr(0,j)+thousand:'')+i.substr(j).replace(/(\d{3})(?=\d)/g,'$1'+thousand)+(places?decimal+Math.abs(number-i).toFixed(places).slice(2):'');};$.extend($,{dump:function(arr,level){var dumped_text="";if(!level)level=0;var level_padding="";for(var j=0;j<level+1;j++)level_padding+="    ";if(typeof(arr)=='object'){for(var item in arr){var value=arr[item];if(typeof(value)=='object'){dumped_text+=level_padding+"'"+item+"' ...\n";dumped_text+=$.dump(value,level+1);}else{dumped_text+=level_padding+"'"+item+"' => \""+value+"\"\n";}}}else{dumped_text="===>"+arr+"<===("+typeof(arr)+")";}
return dumped_text;},wxMenu:{show:function(){wx.ready(function(){wx.showOptionMenu();wx.hideMenuItems({menuList:['menuItem:copyUrl']});wx.onMenuShareAppMessage(sharedata);wx.onMenuShareTimeline(sharedata);wx.onMenuShareQQ(sharedata);wx.onMenuShareWeibo(sharedata);});},hide:function(){wx.ready(function(){wx.hideOptionMenu();});},hideTimeline:function(){wx.ready(function(){wx.hideMenuItems({menuList:['menuItem:share:timeline']});});}},isString:function(s){return Object.prototype.toString.call(s).toLowerCase().indexOf('string')!=-1?true:false;},checkLogin:function(cb){var url=window.sysinfo.check_loginurl;$.ajax({url:url,success:function(res){if(res.errno!=0){$.toast(res.errmsg);setTimeout(function(){$.showIndicator();window.location.href=res.data.url;},2000);}else{if(typeof cb==='function'){cb();}}}});},autoScrolling:function(wrapper,margin_top){if($('.topline_wrap').length>0){$(wrapper).find('ul').animate({marginTop:margin_top},500,function(){$(this).css({marginTop:'0px'}).find('li').slice(0,1).appendTo($(this));});}}});$.wxMenu.hide();;$(function(){'use strict';$(document).on('pageInit',"#superpage_home_display",function(e,id,page){$.wxMenu.show();setInterval(function(){$.autoScrolling('.notice_wrap','-1rem');},5000);$('.open-notice',page).click(function(){$.popup('.popup-notice');$('.pop-title').html($('.notice-title').html());$('.pop-content').html($('.notice-content').html());});var type='default',lat='',lng='';$('.order-item',page).click(function(){var t=this;$(t).addClass('active').siblings().removeClass('active');$('.nodata',page).hide();type=$(t).attr('data-type');var data='page=1&op='+type;if(type=='location'){$.showIndicator();wx.ready(function(){wx.getLocation({type:'gcj02',success:function(res){lat=res.latitude;lng=res.longitude;data+='&lat='+lat+'&lng='+lng;$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});},fail:function(res){console.log(res);}});});}else{$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});}});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<div class="card facebook-card seller-item">';html+='<a href="'+param.url+'&id='+data[i]['id']+'" data-no-cache="true">';html+='<div class="card-header no-border">';html+='<div class="facebook-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='</div>';html+='<div class="facebook-info">';html+='<div class="facebook-name">'+data[i]['nickname']+'</div>';html+='<div class="facebook-date">'+data[i]['time_diff']+'前发布</div>';html+='</div>';if(data[i]['buy_type']==1){if(data[i]['credit']>0){html+='<div class="facebook-price">'+data[i]['credit']+'积分</div>';}else{html+='<div class="facebook-price">面议</div>';}}else{if(data[i]['price']>0){if(data[i]['unit']==1){html+='<div class="facebook-price">'+data[i]['price']+'美元</div>';}else{html+='<div class="facebook-price">'+data[i]['price']+'元</div>';}}else{html+='<div class="facebook-price">面议</div>';}}
html+='</div>';html+='<div class="card-content">';if(data[i]['status']==2){html+='<div class="sell-status">';html+='<img src="'+window.sysinfo.mobile_path+'images/yz.png">';html+='</div>';}
if(data[i]['album'].length==1){html+='<div class="img-box w50">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][0])+'">';html+='</div>';}else if(data[i]['album'].length>1){for(var j=0;j<data[i]['album'].length;j++){html+='<div class="img-box">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][j])+'">';html+='</div>';}}
html+='<p>'+data[i]['title']+'</p>';if(data[i]['comment']){html+='<div class="item-message">';html+='<p>'+data[i]['comment']['buyer_name']+'：'+data[i]['comment']['message']+'</p>';if(data[i]['comment']['reply']){html+='<p>主人回复：'+data[i]['comment']['reply']+'</p>';}
html+='</div>';}
html+='</div>';html+='<div class="card-footer">';html+='<div class="float-left">';html+='<div><i class="iconfont icon-pos"></i>'+data[i]['address']+'</div>';html+='</div>';html+='<div class="float-right">';html+='<div class="inline">';html+='<span class="iconfont icon-praise"></span><span>'+data[i]['zan']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-xiaoxi"></span><span>'+data[i]['message']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-eye"></span><span>'+data[i]['page_view']+'</span>';html+='</div>';html+='</div>';html+='</div>';html+='</a>';html+='</div>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;var data='page='+pageno+'&op='+type+'&lat='+lat+'&lng='+lng;$.ajax({url:$(t).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();$('.nodata',page).show();}}});});if($('.login-page',page).length>0){$('.mask .close',page).click(function(){$('.mask',page).parent().hide();});$('.click-sign',page).click(function(){$('.mask',page).parent().hide();});$('.btn-login',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=$(t).data('url');$.ajax({type:'post',url:url,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){$.toast(resp.errmsg);if(resp.errno==0){setTimeout(function(){window.location.href=window.location.href;},2000);}}})});}});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_order_display",function(e,id,page){$('.send_order',page).click(function(){var id=$(this).data('id');var url=$('.footer-right',page).data('url');$.confirm('确认已在线下完成发货流程？',function(){$.ajax({url:url,data:'status=2&orderid='+id,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('发货成功');window.location.reload();}else{$.toast(res.errmsg);}}});});});$('.cancel_order',page).click(function(){var id=$(this).data('id');var url=$('.footer-right',page).data('url');$.prompt('请填写取消原因',function(value){$.ajax({url:url,data:'status=-1&orderid='+id+'&reason='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('订单已取消');window.location.reload();}else{$.toast(res.errmsg);}}});});});$('.confirm_order',page).click(function(){var id=$(this).data('id');var url=$('.footer-right',page).data('url');$.confirm('确认已经收到该物品吗？',function(){$.ajax({url:url,data:'status=3&orderid='+id,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('已收货');window.location.reload();}else{$.toast(res.errmsg);}}});});});$('.delete_order',page).click(function(){var url=$(this).data('url');$.confirm('确认要删除该订单吗？',function(){$.ajax({url:url,beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('已删除');window.location.reload();}else{$.toast(res.errmsg);}}});});});});});$(function(){'use strict';$(document).on('pageInit',"#superpage_order_comment",function(e,id,page){$('.btn_post',page).click(function(){var orderid=$('input[name=orderid]',page).val();var token=$('input[name=token]',page).val();var url=$(this).data('url');var backurl=$(this).data('backurl');var level=$("select[name=level]",page).val();var message=$("textarea[name=message]",page).val();if(message==''){$.toast('请输入评价内容');return false;}
$.ajax({url:url,data:{'orderid':orderid,'level':level,'message':message,'token':token,'submit':'yes',},dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('评价成功');window.location.href=backurl;}else{$.toast(res.errmsg);}}});});});});$(function(){'use strict';$(document).on('pageInit',"#superpage_item_audit",function(e,id,page){$('input[name="status"]').click(function(){var t=this;if($(t).val()==0){$('.reason').show();}else{$('.reason').hide();}});$('.btn_post',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=$(t).attr('data-url');var status=$('input[name=status]:checked').val();var reason=$('textarea[name=reason]',page).val();if(status==0&&reason==''){$.toast('请填写拒绝原因');$(t).removeClass('disabled');return false;}
var token=$('input[name=token]',page).val();var data='';data+='token='+token;data+='&status='+status;data+='&reason='+reason;data+='&submit=yes';$.ajax({type:'post',url:url,data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){$.toast(resp.errmsg);if(resp.errno==0){if(resp.data.url){$.showIndicator();setTimeout(function(){window.location.href=resp.data.url;},2000);}}else{$(t).removeClass('disabled');}}})});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_detail",function(e,id,page){$.wxMenu.show();var photos=[];$('.pic-item',page).each(function(){photos.push($(this).html());});var myPhotoBrowserStandalone=$.photoBrowser({photos:photos});$(document).on('click','.show-pic',function(){myPhotoBrowserStandalone.open();});$('.open-notice',page).click(function(){$.popup('.popup-notice');$('.pop-title').html($('.notice-title').html());$('.pop-content').html($('.notice-content').html());});var reg=new RegExp(/((((13[0-9])|(15[^4])|(18[0,1,2,3,5-9])|(17[0-8])|(147))\d{8})|((\d3,4|\d{3,4}-|\s)?\d{7,14}))?/g);var text=$('.detail-desc',page).html();if(text){var tel=text.match(reg);if(tel.length>0){for(var i=0;i<tel.length;i++){if(tel[i]){var tel_html='<a style="color:#f60;" href="tel:'+tel[i]+'">'+tel[i]+'</a>';$('.detail-text',page).html(text.replace(tel[i],tel_html));}}}}
$('.leave-message').click(function(){$.checkLogin(function(){$.prompt('请输入留言内容',function(value){$.ajax({url:$('.action-bar').attr('data-url'),data:'comment='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast(res.errmsg)
window.location.reload();}else{$.toast('留言提交失败，请重新提交')}}});})});});$('.report').click(function(){$.checkLogin(function(){$.prompt('请输入举报原因',function(value){$.ajax({url:$('.action-bar').attr('data-url'),data:'comment='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast(res.errmsg)
window.location.reload();}else{$.toast('提交失败，请重新提交')}}});})});});$('.reply-btn').click(function(){var t=this;$.checkLogin(function(){$.prompt('请输入回复内容',function(value){var id=$(t).attr('data-id');$.ajax({url:$('.action-bar').attr('data-url'),data:'msg_id='+id+'&reply='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('回复成功');var html='<div class="item-message"><p>主人回复：'+value+'</p></div>';$(t).parent().parent().parent().find('.card-content-inner').append(html);$(t).remove();}else{$.toast('回复失败');}}});});});});$('.show-map').click(function(){var lng=$(this).data('lng');var lat=$(this).data('lat');if(lng&&lat){wx.openLocation({latitude:lat,longitude:lng,scale:18,});}});$('.favour').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$('.action-bar').attr('data-url'),data:'type=1&status='+$(t).attr('data-status'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){if($(t).attr('data-status')=='1'){$(t).attr('data-status',0);$(t).find('.iconfont').removeClass('icon-praise1').addClass('icon-praise');var count=parseInt($('.zan-count').html())-1;$.toast('点赞 -1');}else{$(t).attr('data-status',1);$(t).find('.iconfont').removeClass('icon-praise').addClass('icon-praise1');var count=parseInt($('.zan-count').html())+1;$.toast('点赞 +1');}
$('.zan-count').html(count);}}});});});$('.collect').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$('.action-bar').attr('data-url'),data:'type=2&status='+$(t).attr('data-status'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){if($(t).attr('data-status')=='1'){$(t).attr('data-status',0);$(t).find('.iconfont').removeClass('icon-fav1').addClass('icon-fav');$.toast('收藏 -1');}else{$(t).attr('data-status',1);$(t).find('.iconfont').removeClass('icon-fav').addClass('icon-fav1');$.toast('收藏 +1');}}}});});});$('.chat-btn').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$(t).attr('data-url'),data:'from_uid='+$(t).attr('data-from-uid')+'&chat='+1,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){window.location.href=res.data.url;}else{$.toast('聊天初始化失败，请稍后再试');}}});});});$('.status-btn').click(function(){var t=this;var text,status,tips;if($(t).html()=='已下架'){text='上架';status=1;tips='上架物品将会展示在列表中并且会收到关于该物品的聊天消息';}else{text='下架';status=-1;tips='下架物品将不会展示在列表中并且不会收到关于该物品的聊天消息';}
var buttons1=[{text:'请选择',label:true},{text:'已转让',color:'default',onClick:function(){$.confirm('转让物品后将不会收到聊天消息','确定该物品已转让?',function(){$.ajax({url:$(t).attr('data-url'),data:'status=2',dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){$.toast(res.errmsg);if(res.errno==0){$('.status-btn').html('已转让');}}});});}},{text:text,onClick:function(){$.confirm(tips,'确定要'+text+'该物品?',function(){$.ajax({url:$(t).attr('data-url'),data:'status='+status,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){$.toast(res.errmsg);if(res.errno==0){$('.status-btn').html('已'+text);}}});});}},{text:'编辑',onClick:function(){window.location.href=$(t).attr('data-edit-url');}},{text:'取消'}];var groups=[buttons1];$.actions(groups);});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_list",function(e,id,page){var type='default',lat='',lng='';$('.order-item',page).click(function(){var t=this;$(t).addClass('active').siblings().removeClass('active');$('.nodata',page).hide();type=$(t).attr('data-type');var data='page=1&op='+type;if(type=='location'){wx.getLocation({type:'gcj02',success:function(res){lat=res.latitude;lng=res.longitude;data+='&lat='+lat+'&lng='+lng;$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});},fail:function(res){console.log(res);}});}else{$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});}});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<div class="card facebook-card seller-item">';html+='<a href="'+param.url+'&id='+data[i]['id']+'" data-no-cache="true">';html+='<div class="card-header no-border">';html+='<div class="facebook-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='</div>';html+='<div class="facebook-info">';html+='<div class="facebook-name">'+data[i]['nickname']+'</div>';html+='<div class="facebook-date">'+data[i]['time_diff']+'前发布</div>';html+='</div>';if(data[i]['buy_type']==1){if(data[i]['credit']>0){html+='<div class="facebook-price">'+data[i]['credit']+'积分</div>';}else{html+='<div class="facebook-price">面议</div>';}}else{if(data[i]['price']>0){if(data[i]['unit']==1){html+='<div class="facebook-price">'+data[i]['price']+'美元</div>';}else{html+='<div class="facebook-price">'+data[i]['price']+'元</div>';}}else{html+='<div class="facebook-price">面议</div>';}}
html+='</div>';html+='<div class="card-content">';if(data[i]['status']==2){html+='<div class="sell-status">';html+='<img src="'+window.sysinfo.mobile_path+'images/yz.png">';html+='</div>';}
if(data[i]['album'].length==1){html+='<div class="img-box w50">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][0])+'">';html+='</div>';}else if(data[i]['album'].length>1){for(var j=0;j<data[i]['album'].length;j++){html+='<div class="img-box">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][j])+'">';html+='</div>';}}
html+='<p>'+data[i]['title']+'</p>';if(data[i]['comment']){html+='<div class="item-message">';html+='<p>'+data[i]['comment']['buyer_name']+'：'+data[i]['comment']['message']+'</p>';if(data[i]['comment']['reply']){html+='<p>主人回复：'+data[i]['comment']['reply']+'</p>';}
html+='</div>';}
html+='</div>';html+='<div class="card-footer">';html+='<div class="float-left">';html+='<div><i class="iconfont icon-pos"></i>'+data[i]['address']+'</div>';html+='</div>';html+='<div class="float-right">';html+='<div class="inline">';html+='<span class="iconfont icon-praise"></span><span>'+data[i]['zan']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-xiaoxi"></span><span>'+data[i]['message']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-eye"></span><span>'+data[i]['page_view']+'</span>';html+='</div>';html+='</div>';html+='</div>';html+='</a>';html+='</div>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;var data='page='+pageno+'&op='+type+'&lat='+lat+'&lng='+lng;$.ajax({url:$(t).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();$('.nodata',page).show();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_post",function(e,id,page){$('.post-book',page).click(function(){var buttons1=[{text:'请选择',label:true},{text:'扫码上传',onClick:function(){wx.scanQRCode({needResult:1,scanType:["barCode"],success:function(res){var result=res.resultStr;$('.html',page).html(result);}});}},{text:'手动上传',onClick:function(){$('.before-post',page).addClass('hide-item');$('.post-form',page).removeClass('hide-item');}}];var buttons2=[{text:'取消',bg:'danger'}];var groups=[buttons1,buttons2];$.actions(groups);});$('.post-other,.post-next',page).click(function(){$('.before-post',page).addClass('hide-item');$('.post-form',page).removeClass('hide-item');});$('.buy-type',page).change(function(){if($(this).val()==1){$('.credit_wrap',page).removeClass('hide-item');$('.cash_wrap',page).addClass('hide-item');}else{$('.credit_wrap',page).addClass('hide-item');$('.cash_wrap',page).removeClass('hide-item');}});var sp_list=$('.district').find('span');var dt_list=[];if(sp_list){for(var i=0;i<sp_list.length;i++){dt_list.push(sp_list.eq(i).html());}}
function getLonandLat(){wx.ready(function(){wx.getLocation({type:'gcj02',success:function(res){var lat=res.latitude;var lng=res.longitude;$('#latitude',page).val(lat);$('#longitude',page).val(lng);},cancel:function(){$.alert('打开地理位置以便获取您所在的小区',function(){getLonandLat();});}});});}
if(!$('#latitude',page).val()||$('#longitude',page).val()){getLonandLat();}
var album=[];if($('.item-img-wrap',page).find('img')){var img_list=$('.item-img-wrap',page).find('img');for(var i=0;i<img_list.length;i++){album.push(img_list.eq(i).attr('src'));}}
$('.add-img',page).off("click").on("click",function(){if(window.sysinfo.container=='wechat'){wx.chooseImage({count:9,sizeType:['original','compressed'],sourceType:['album','camera'],success:function(res){var localIds=res.localIds;for(let i=0;i<localIds.length;i++){var img="<img src='"+localIds[i]+"'>";$('.item-img-wrap',page).prepend(img);}
syncUpload(localIds);}});}else{$.toast('请在微信中上传图片');}});function syncUpload(localIds){var localId=localIds.pop();$('.item-img-wrap',page).prepend("<img src='"+localId+"'");wx.uploadImage({localId:localId,isShowProgressTips:0,success:function(res){var serverId=res.serverId;album.push(serverId);if(localIds.length>0){syncUpload(localIds);}else{$('#serverId',page).val(album);}}});}
$('.rule',page).click(function(){$.popup('.popup-rule');});window.addEventListener("resize",function(){if(document.activeElement.tagName=="INPUT"){window.setTimeout(function(){document.activeElement.scrollIntoViewIfNeeded();},0);}});$('.btn_post',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=$(t).attr('data-url');var longitude=$('input[name=longitude]',page).val();var latitude=$('input[name=latitude]',page).val();var title=$('input[name=title]',page).val();var content=$('textarea[name=description]',page).val();var cid=$('select[name=category]',page).val();var unit=$('select[name=unit]',page).val();var buy_type=$('select[name=buy_type]',page).val();var price=$('input[name=price]',page).val();var credit=$('input[name=credit]',page).val();var address=$('input[name=address]',page).val();var wechatpay=$('select[name=wechatpay]',page).val();var set_top=$('select[name=set_top]',page).val();var token=$('input[name=token]',page).val();if(title==''){$.toast('请输入物品标题');$(t).removeClass('disabled');return false;}
if(album.length==0){$.toast('请上传物品图片');$(t).removeClass('disabled');return false;}
if(cid==0){$.toast('请选择物品分类');$(t).removeClass('disabled');return false;}
if(!$(t).attr('data-id')){if(!$('input[name=rule]').prop('checked')){$.toast('请先阅读物品发布公约');$(t).removeClass('disabled');return false;}}
var fields='';var fields_value=$('.fields_value',page);if(typeof fields_value!=='undefined'){var value_key;fields_value.each(function(){value_key=$(this).attr('data-fields-key');if($(this).attr('type')==='checkbox'){if($(this).prop('checked')){fields+='&fields_value['+value_key+'][]='+$(this).val();}}else if($(this).attr('type')==='radio'){if($(this).prop('checked')){fields+='&fields_value['+value_key+']='+$(this).val();}}else{fields+='&fields_value['+value_key+']='+$(this).val();}});}
var data='';data+='token='+token;data+='&id='+$(t).attr('data-id');data+='&title='+title;data+='&serverIds='+album;data+='&longitude='+longitude;data+='&latitude='+latitude;data+='&description='+content;data+='&cid='+cid;data+='&address='+address;data+='&price='+price;data+='&wechatpay='+wechatpay;data+='&set_top='+set_top;data+='&submit=yes';data+='&buy_type='+buy_type;data+='&unit='+unit;data+='&credit='+credit;if(fields!=''){data+='&fields='+fields;}
$.ajax({type:'post',url:url,data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){if(resp.data.url){let url=resp.data.url;let settop_url=resp.data.settop_url;let text=resp.errmsg;if(set_top==1){url=settop_url;text='发布成功，去付费置顶...'}
$.toast(text);setTimeout(function(){window.location.href=url;},2000);}}else{$.toast(resp.errmsg);$(t).removeClass('disabled');}}})});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_confirm",function(e,id,page){$('.btn_post',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=window.location.href;var type=$(t).data('type');var address=$('input[name=address]',page).val();var remark=$('textarea[name=remark]',page).val();var name=$('.username',page).html();var mobile=$('.hide_mobile',page).html();var token=$('input[name=token]',page).val();if(address==''){$.toast('请获取收货地址');$(t).removeClass('disabled');return false;}
$.ajax({type:'post',url:url,data:{'token':token,'username':name,'mobile':mobile,'address':address,'remark':remark,'submit':'yes'},dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){if(type==0){WeixinJSBridge.invoke('getBrandWCPayRequest',{"appId":resp.data.appId,"timeStamp":resp.data.timeStamp,"nonceStr":resp.data.nonceStr,"package":resp.data.package,"signType":resp.data.signType,"paySign":resp.data.paySign},function(res){if(res.err_msg=="get_brand_wcpay_request:ok"){window.location.href=resp.data.redirect_url;}else if(res.err_msg=='get_brand_wcpay_request:cancel'){$.toast('您取消了本次支付！');}else{$.alert(res.err_msg);}});}else{$.toast('兑换成功');setTimeout(function(){window.location.href=resp.data.redirect_url;},2000)}}else{$.alert(resp.errmsg);}}})});$('.get-address',page).click(function(){var t=this;wx.ready(function(){wx.openAddress({trigger:function(result){console.log('openAddress: trigger');console.log(result);},success:function(result){console.log('openAddress: success');console.log(result);var username=result.userName;var mobile=result.telNumber;var address=result.provinceName+' '+result.cityName+' '+result.countryName+' '+result.detailInfo;$(t).addClass('hide-item');$('.wechat_address',page).removeClass('hide-item');$('input[name=address]',page).val(address);$('.wechat_address .item-text',page).html(address);$('.wechat_address .item-title .username',page).html(username);$('.wechat_address .item-title .hide_mobile',page).html(mobile);},cancel:function(result){console.log('openAddress: cancel');console.log(result);},fail:function(result){console.log('openAddress: fail');console.log(result);}});});});});});;$(function(){'use strict';$(document).on('pageInit',".superpage_message",function(e,id,page){var chaturl=$(this).data('chaturl');if(!chaturl){chaturl=document.domain;}
console.log(document.location.protocol)
window.ChatBox=window.ChatBox||{conn:null,client_id:'',init:function(){this.connect();},connect:function(){var protocol=document.location.protocol=='https:'?'wss://':'ws://';this.conn=new WebSocket(protocol+chaturl+"/websocket");this.conn.onopen=this.onopen;this.conn.onmessage=this.onmessage;this.conn.onclose=this.onclose;this.conn.onerror=this.onerror;},onopen:function(){console.log('ws connect open ...');if($('#message-list .chat-link',page).hasClass('disabled')){$('#message-list .chat-link',page).removeClass('disabled');}
var data={type:'login',sid:window.sysinfo.member.sid,uid:window.sysinfo.member.uid,nickname:window.sysinfo.member.nickname,uniacid:window.sysinfo.uniacid};ChatBox.send(data);},onmessage:function(e){console.log('ws received message: '+e.data);var data=JSON.parse(e.data);switch(data['type']){case'ping':ChatBox.send({type:'pong'});break;case'say':ChatPage.message(data);break;case'logout':break;}},onclose:function(e){console.log("ws connect closed.");console.log(e);},onerror:function(e){console.error('ws error: '+e);$('#message-list .chat-link',page).addClass('disabled');},send:function(data){if(!$.isString(data)){data=JSON.stringify(data);}
this.conn.send(data);console.log('ws sended message: '+data);}};ChatBox.init();document.addEventListener("visibilitychange",function(e){if(e.hidden){}
else{ChatBox.init();}});$('.chat-link',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
pushHistory();var url=$(t).data('url');$.ajax({url:url,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){$(t).data('active',1);$('.dot',t).hide();var tpl=$('#tpl_chat').html();var list=resp.data.message;if(list.length>0){for(var i=0;i<list.length;i++){list[i].message=explain(list[i].message);}}
var html=_.template(tpl)(resp.data);$('.popup-chat').html(html);$.popup('.popup-chat');ChatPage.init(page);}else{$.alert(resp.errno+':'+resp.errmsg);}}});});function explain(str){var reg=new RegExp(/\[[A-Z]*[\u4E00-\u9FA5]*\]/,'g');var list=window.emojis.qq.sources;var path=window.emojis.qq.path;return str.replace(reg,function(ss){for(var i=0;i<list.length;i++){var title='['+list[i].title+']';if(title==ss){return'<img src="'+path+list[i].url+'" />';}}});}
var ChatPage={init:function(page){ChatPage.refreshScroll();$('.txtMessage').unbind('keyup').keyup(function(e){if(e.keyCode!=13){return;}
$('.btnSend').trigger('click');});$('.btnSend').unbind('click').click(function(){var t=this;var itemid=$(t).data('itemid');var fromuid=$(t).data('fromuid');var message=$('.txtMessage');if(message.val()==''){$.toast('请输入消息');return false;}
if(message.val().length>=2048){$.toast('输入消息太长，请分开发送');return false;}
if($('.message_toolbar').css('bottom')!=0){$('.message_toolbar').css('bottom',0);$('.wrapper').hide();}
$.showIndicator();var data={type:'say',from_uid:window.sysinfo.member.uid,to_uid:fromuid,itemid:itemid,content:message.val(),createtime:parseInt(new Date().getTime()/1000),from:'wechat'};ChatBox.send(data);window.scroll(0,0);});$('#emoj').click(function(){$('.wrapper').show();$('.message_toolbar').css('bottom','161px');var text=document.querySelector(".txtMessage");var we=new wantEmoji({wrapper:".wrapper",row:3,callback:function(emojiCode){text.value+=emojiCode;text.focus();},autoInit:true});});$('.txtMessage').focus(function(){setTimeout(function(){window.scrollTo(0,$('body').height());},300);});$('.open-item-modal').click(function(){var img=$('.hide-item').find('img');var des=$('.hide-item .item-text').html();var url=$('.hide-item').data('url');var html='';if(img.length>0){for(var i=0;i<img.length;i++){html+='<img src="'+img.eq(i).attr('src')+'">'}}
$.modal({title:'物品详情',text:'<div class="item-box">'+'<div class="img-list">'+html+'</div>'+'<div class="item-text">'+des+'</div>'+'</div>',buttons:[{text:'去购买',onClick:function(){window.location.href=url}},{text:'返回聊天',},]})});function loadMessage(data){var html='';if(data.message.length>0){for(var i=0;i<data.message.length;i++){if(data.message[i].from_uid==window.sysinfo.member.uid){html+='<div class="message-item float-left clearfix">';html+='<div class="message-avatar block">';html+='<img src="'+data.to.avatar+'">';html+='</div>';html+='<div class="message-box block">'+data.message[i].message+'</div>';html+='</div>';}else{html+='<div class="message-item float-right clearfix">';html+='<div class="message-avatar block">';html+='<img src="'+data.from.avatar+'">';html+='</div>';html+='<div class="message-box block">'+data.message[i].message+'</div>';html+='</div>';}}}else{html+='<div class="text-center color-gray font6 margin-bottom">没有更多了</div>';}
$('.message_list').prepend(html);}
$(document).on('refresh','.pull-to-refresh-content',function(e){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');var itemid=$(t).attr('data-itemid');var fromuid=$(t).attr('data-fromuid');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno+'&itemid='+itemid+'&fromuid='+fromuid,dataType:'json',success:function(resp){if(resp.data.message.length>0){$(t).attr('data-flag','0');loadMessage(resp.data);$(t).attr('data-page',pageno);$.pullToRefreshDone('.pull-to-refresh-content');$.refreshScroller();}else{$(t).attr('data-flag','1');loadMessage(resp.data);$.destroyPullToRefresh('.pull-to-refresh-content');$('.pull-to-refresh-layer').remove();}}});});},refreshScroll:function(){$.refreshScroller();$('.content').scrollTop($('.message_list').height()-$('.content').height());},message:function(data){var fromuid=$('.btnSend').data('fromuid');if(data.from_uid!=fromuid&&data.to_uid!=fromuid){$('.chat-link',page).each(function(){if($(this).data('active')){return true;}
if($(this).data('fromuid')==data.from_uid){$('.dot',this).show();$('.item-subtitle',this).html(data.content);return false;}});return;}
$.hideIndicator();$('.txtMessage').val('');var tpl=$('#tpl_message').html();var avatar,float;if(data.to_uid==window.sysinfo.member.uid){float='float-left';avatar=$('.pull-to-refresh-content').attr('data-from-avatar');}else{float='float-right';avatar=$('.pull-to-refresh-content').attr('data-avatar');}
var params={float:float,avatar:avatar,content:explain(data.content),};var html=_.template(tpl)(params);$('.message_list').append(html);ChatPage.refreshScroll();}};$('#message-list li').each(function(){if($(this).attr('data-from')){$(this).children('.chat-link').trigger('click');}});$('.hide-delete').click(function(){var t=this;$.confirm('确定要删除该条消息吗?',function(){$.ajax({url:$(t).attr('data-url'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('删除成功');window.location.reload();}else{$.toast('删除出错，请稍后重试');}}});});});function pushHistory(){var state={title:"title",url:"#"};window.history.pushState(state,"title","#");};window.onpopstate=function(){if($('.popup-chat').hasClass('modal-in')){$.closeModal('.popup-chat');}};function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<li>';html+='<a class="item-link item-content chat-link" data-url="'+param.url+'&itemid='+data[i]['itemid']+'" data-fromuid="'+data[i]['from_uid']+'" data-touid="'+data[i]['uid']+'" data-itemid="'+data[i]['itemid']+'" href="#">';html+='<div class="item-media block-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='<div class="dot"></div>';html+='</div>';html+='<div class="item-inner">';html+='<div class="item-title-row">';html+='<div class="item-title font75">'+data[i]['nickname']+'</div>';html+='</div>';html+='<div class="item-subtitle color-gray font65">'+data[i]['message']+'</div>';html+='<div class="item-img">';html+='<img src="'+param.img_url+data[i]['cover']+'" alt="">'
html+='</div>';html+='</div>';html+='</a>';html+='</li>';}
$('#message-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno,dataType:'json',success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_pay_top_display",function(e,id,page){$('.position-select',page).change(function(){let id=$(this).val();$('.position-hide .position-item').each(function(){if($(this).data('id')==id){let list=$(this).children('span');let html='<option value="0">请选择置顶方式</option>';list.each(function(){html+='<option value="'+$(this).data('type')+'" text="'+$(this).data('price')+'">'+$(this).html()+'</option>'})
$('.type-select',page).html('');$('.type-select',page).append(html);}});});$('.type-select',page).change(function(){let price=$(this).find('option:checked').attr('text');$('.price',page).val(price);})
$('.count',page).on('input',function(){let count=$(this).val();let price=$('.price',page).val();let total=Math.floor(parseFloat(count)*parseFloat(price)*100)/100;$('.money',page).html('（共'+total+'元）')})
$('.btn_post',page).click(function(){let t=this;let itemid=$('input[name=itemid]',page).val();let pid=$('select[name=position]',page).val();let tid=$('select[name=type]',page).val();let total=$('input[name=count]',page).val();if(!pid){$.toast('请选择置顶位置');return false;}
if(!tid){$.toast('请选择置顶方式');return false;}
if(!total){$.toast('请填写购买数量');return false;}
let data='itemid='+itemid+'&positionid='+pid+'&type='+tid+'&total='+total;$.ajax({url:$(t).attr('data-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){WeixinJSBridge.invoke('getBrandWCPayRequest',{"appId":resp.data.appId,"timeStamp":resp.data.timeStamp,"nonceStr":resp.data.nonceStr,"package":resp.data.package,"signType":resp.data.signType,"paySign":resp.data.paySign},function(res){if(res.err_msg=="get_brand_wcpay_request:ok"){$.toast('购买成功');window.location.href=$(t).attr('data-homeurl');}else if(res.err_msg=='get_brand_wcpay_request:cancel'){$.toast('您取消了本次支付！');}else{$.toast(res.err_msg);}});}else{$.toast('支付失败，请稍后重试');}}});});})});$(function(){'use strict';$(document).on('pageInit',"#superpage_my_item_list",function(e,id,page){$('.hide-delete',page).click(function(){var t=this;$.confirm('确定要删除该物品吗?',function(){$.ajax({url:$(t).attr('data-url'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('删除成功');window.location.reload();}else{$.toast('删除出错，请稍后重试');}}});});});$('.like-btn',page).click(function(e){e.preventDefault();window.location.href=$(this).data('url');});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<li>';html+='<a class="item-link item-content chat-link" data-no-cache="true" href="'+param.url+'&id='+data[i]['id']+'">';html+='<div class="item-media block-avatar">';html+='<img src="'+param.img_url+data[i]['cover']+'">';html+='</div>';html+='<div class="item-inner">';html+='<div class="item-title-row">';html+='<div class="item-title font75">'+data[i]['title']+'</div>';html+='</div>';html+='<div class="item-subtitle color-gray font65">'+data[i]['nickname']+'发表于'+data[i]['time_diff']+'前</div>';html+='</div>';html+='</a>';html+='</li>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno,dataType:'json',success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_finance_getcash",function(e,id,page){$('select[name=account_type]').change(function(){$('.account_wrap').addClass('hide-item');var account_type=$(this).val();if(account_type!='wechat'){$('.'+account_type).removeClass('hide-item');}});$('input[name=money]').on('input',function(){var money=parseFloat($(this).val());var limit=parseFloat($(this).attr('data-limit'));var fee_rate=parseFloat($(this).attr('data-fee-rate'));var fee_min=parseFloat($(this).attr('data-fee-min'));var fee_max=parseFloat($(this).attr('data-fee-max'));if(!money){return;}
if(money<limit){$(this).parent().removeClass('has-success').addClass('has-error');$('.fee').text('0');}else{$(this).parent().removeClass('has-error').addClass('has-success');var fee=(money*fee_rate);fee=fee<fee_min?fee_min:(fee>fee_max?fee_max:fee);if(money>fee){$('.fee').html(fee);}}});$('.btn_post',page).click(function(){var token=$('input[name=token]',page).val();var account_type=$('select[name=account_type]').val();var remark=$('textarea[name=remark]').val();var alipay_account=$('input[name=alipay_account]').val();var alipay_username=$('input[name=alipay_username]').val();var bank_name=$('input[name=bank_name]').val();var bank_account=$('input[name=bank_account]').val();var bank_cardno=$('input[name=bank_cardno]').val();var bank_username=$('input[name=bank_username]').val();var money=$('input[name=money]').val();var getcsh_setting=$('input[name=getcsh_setting]');var limit=parseFloat(getcsh_setting.attr('data-limit'));var balance=parseFloat(getcsh_setting.attr('data-balance'));if(account_type==''){$.toast('提现方式不存在，请联系管理员');return false;}
if(account_type=='alipay'){if(alipay_account==''||alipay_username==''){$.toast('请添加支付宝账户信息');return false;}}
if(account_type=='bank'){if(bank_name==''||bank_account==''||bank_cardno==''||bank_username==''){$.toast('请添加银行账户信息');return false;}}
if(money==''){$.toast('提现金额为空，请重新填写');return false;}
if(money<limit){$.toast('提现金额低于最低提现金额，请重新填写');return false;}
if(money>balance){$.toast('提现金额高于可提金额，请重新填写');return false;}
$.ajax({type:'post',url:window.location.href,data:{'account_type':account_type,'alipay_account':alipay_account,'alipay_username':alipay_username,'bank_name':bank_name,'bank_account':bank_account,'bank_cardno':bank_cardno,'bank_username':bank_username,'remark':remark,'money':money,'token':token,'submit':'yes'},dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){let url=resp.data.url;$.toast('提交成功，等待结算中...');setTimeout(function(){window.location.href=url;},2000);}else{$.toast(resp.errmsg);$(t).removeClass('disabled');}}})});});});;$(function(){'use strict';$(document).on('pageInit',".page",function(e,id,page){$.ajax({url:'./index.php?c=entry&do=stat&act=display&m=superman_hand2&i='+window.sysinfo.uniacid,success:function(response){console.log('stat display: ok');}});$('.lazyload').picLazyLoad({element:$('.content'),threshold:100});$('.external').each(function(){if($(this).attr('href')!=''){$(this).click(function(){$.showIndicator();});}});});$.init();});
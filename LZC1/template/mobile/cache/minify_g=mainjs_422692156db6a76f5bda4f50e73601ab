Number.prototype.formatCurrency=function(places,symbol,thousand,decimal){places=!isNaN(places=Math.abs(places))?places:2;symbol=symbol!==undefined?symbol:'&#165;';thousand=thousand||',';decimal=decimal||'.';var number=this,negative=number<0?'-':'',i=parseInt(number=Math.abs(+number||0).toFixed(places),10)+'',j=(j=i.length)>3?j%3:0;return symbol+negative+(j?i.substr(0,j)+thousand:'')+i.substr(j).replace(/(\d{3})(?=\d)/g,'$1'+thousand)+(places?decimal+Math.abs(number-i).toFixed(places).slice(2):'');};$.extend($,{dump:function(arr,level){var dumped_text="";if(!level)level=0;var level_padding="";for(var j=0;j<level+1;j++)level_padding+="    ";if(typeof(arr)=='object'){for(var item in arr){var value=arr[item];if(typeof(value)=='object'){dumped_text+=level_padding+"'"+item+"' ...\n";dumped_text+=$.dump(value,level+1);}else{dumped_text+=level_padding+"'"+item+"' => \""+value+"\"\n";}}}else{dumped_text="===>"+arr+"<===("+typeof(arr)+")";}
return dumped_text;},wxMenu:{show:function(){wx.ready(function(){wx.showOptionMenu();wx.hideMenuItems({menuList:['menuItem:copyUrl']});wx.onMenuShareAppMessage(sharedata);wx.onMenuShareTimeline(sharedata);wx.onMenuShareQQ(sharedata);wx.onMenuShareWeibo(sharedata);});},hide:function(){wx.ready(function(){wx.hideOptionMenu();});},hideTimeline:function(){wx.ready(function(){wx.hideMenuItems({menuList:['menuItem:share:timeline']});});}},isString:function(s){return Object.prototype.toString.call(s).toLowerCase().indexOf('string')!=-1?true:false;},checkLogin:function(cb){var url=window.sysinfo.check_loginurl;$.ajax({url:url,success:function(res){if(res.errno!=0){$.toast(res.errmsg);setTimeout(function(){$.showIndicator();window.location.href=res.data.url;},2000);}else{if(typeof cb==='function'){cb();}}}});},autoScrolling:function(wrapper,margin_top){if($('.topline_wrap').length>0){$(wrapper).find('ul').animate({marginTop:margin_top},500,function(){$(this).css({marginTop:'0px'}).find('li').slice(0,1).appendTo($(this));});}}});$.wxMenu.hide();;$(function(){'use strict';$(document).on('pageInit',"#superpage_home_display",function(e,id,page){$.wxMenu.show();setInterval(function(){$.autoScrolling('.notice_wrap','-1rem');},5000);$('.open-notice',page).click(function(){$.popup('.popup-notice');$('.pop-title').html($('.notice-title').html());$('.pop-content').html($('.notice-content').html());});var type='default',lat='',lng='';$('.order-item',page).click(function(){var t=this;$(t).addClass('active').siblings().removeClass('active');$('.nodata',page).hide();type=$(t).attr('data-type');var data='page=1&op='+type;if(type=='location'){$.showIndicator();wx.ready(function(){wx.getLocation({type:'gcj02',success:function(res){lat=res.latitude;lng=res.longitude;data+='&lat='+lat+'&lng='+lng;$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});},fail:function(res){console.log(res);}});});}else{$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});}});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<div class="card facebook-card seller-item">';html+='<a href="'+param.url+'&id='+data[i]['id']+'" data-no-cache="true">';html+='<div class="card-header no-border">';html+='<div class="facebook-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='</div>';html+='<div class="facebook-info">';html+='<div class="facebook-name">'+data[i]['nickname']+'</div>';html+='<div class="facebook-date">'+data[i]['time_diff']+'前发布</div>';html+='</div>';if(data[i]['buy_type']==1){if(data[i]['credit']>0){html+='<div class="facebook-price">'+data[i]['credit']+'积分</div>';}else{html+='<div class="facebook-price">面议</div>';}}else{if(data[i]['price']>0){if(data[i]['unit']==1){html+='<div class="facebook-price">'+data[i]['price']+'美元</div>';}else{html+='<div class="facebook-price">'+data[i]['price']+'元</div>';}}else{html+='<div class="facebook-price">面议</div>';}}
html+='</div>';html+='<div class="card-content">';if(data[i]['status']==2){html+='<div class="sell-status">';html+='<img src="'+window.sysinfo.mobile_path+'images/yz.png">';html+='</div>';}
if(data[i]['album'].length==1){html+='<div class="img-box w50">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][0])+'">';html+='</div>';}else if(data[i]['album'].length>1){for(var j=0;j<data[i]['album'].length;j++){html+='<div class="img-box">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][j])+'">';html+='</div>';}}
html+='<p>'+data[i]['title']+'</p>';if(data[i]['comment']){html+='<div class="item-message">';html+='<p>'+data[i]['comment']['buyer_name']+'：'+data[i]['comment']['message']+'</p>';if(data[i]['comment']['reply']){html+='<p>主人回复：'+data[i]['comment']['reply']+'</p>';}
html+='</div>';}
html+='</div>';html+='<div class="card-footer">';html+='<div class="float-left">';html+='<div><i class="iconfont icon-pos"></i>'+data[i]['address']+'</div>';html+='</div>';html+='<div class="float-right">';html+='<div class="inline">';html+='<span class="iconfont icon-praise"></span><span>'+data[i]['zan']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-xiaoxi"></span><span>'+data[i]['message']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-eye"></span><span>'+data[i]['page_view']+'</span>';html+='</div>';html+='</div>';html+='</div>';html+='</a>';html+='</div>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;var data='page='+pageno+'&op='+type+'&lat='+lat+'&lng='+lng;$.ajax({url:$(t).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();$('.nodata',page).show();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_audit",function(e,id,page){$('input[name="status"]').click(function(){var t=this;if($(t).val()==0){$('.reason').show();}else{$('.reason').hide();}});$('.btn_post',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=$(t).attr('data-url');var status=$('input[name=status]:checked').val();var reason=$('textarea[name=reason]',page).val();if(status==0&&reason==''){$.toast('请填写拒绝原因');$(t).removeClass('disabled');return false;}
var token=$('input[name=token]',page).val();var data='';data+='token='+token;data+='&status='+status;data+='&reason='+reason;data+='&submit=yes';$.ajax({type:'post',url:url,data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){$.toast(resp.errmsg);if(resp.errno==0){if(resp.data.url){$.showIndicator();setTimeout(function(){window.location.href=resp.data.url;},2000);}}else{$(t).removeClass('disabled');}}})});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_detail",function(e,id,page){$.wxMenu.show();var imgs=[];var imgObj=$('.preview-img',page);for(var i=0;i<imgObj.length;i++){imgs.push(imgObj.eq(i).find('img').attr('src'));imgObj.eq(i).click(function(){var nowImgurl=$(this).find('img').attr('src');WeixinJSBridge.invoke("imagePreview",{"urls":imgs,"current":nowImgurl});});}
var reg=new RegExp(/((((13[0-9])|(15[^4])|(18[0,1,2,3,5-9])|(17[0-8])|(147))\d{8})|((\d3,4|\d{3,4}-|\s)?\d{7,14}))?/g);var text=$('.detail-desc',page).html();var tel=text.match(reg);if(tel.length>0){for(var i=0;i<tel.length;i++){if(tel[i]){var tel_html='<a style="color:#f60;" href="tel:'+tel[i]+'">'+tel[i]+'</a>';$('.detail-text',page).html(text.replace(tel[i],tel_html));}}}
$('.leave-message').click(function(){$.checkLogin(function(){$.prompt('请输入留言内容',function(value){$.ajax({url:$('.action-bar').attr('data-url'),data:'comment='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast(res.errmsg)
window.location.reload();}else{$.toast('留言提交失败，请重新提交')}}});})});});$('.report').click(function(){$.checkLogin(function(){$.prompt('请输入举报原因',function(value){$.ajax({url:$('.action-bar').attr('data-url'),data:'comment='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast(res.errmsg)
window.location.reload();}else{$.toast('提交失败，请重新提交')}}});})});});$('.reply-btn').click(function(){var t=this;$.checkLogin(function(){$.prompt('请输入回复内容',function(value){var id=$(t).attr('data-id');$.ajax({url:$('.action-bar').attr('data-url'),data:'msg_id='+id+'&reply='+value,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('回复成功');var html='<div class="item-message"><p>主人回复：'+value+'</p></div>';$(t).parent().parent().parent().find('.card-content-inner').append(html);$(t).remove();}else{$.toast('回复失败');}}});});});});$('.favour').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$('.action-bar').attr('data-url'),data:'type=1&status='+$(t).attr('data-status'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){if($(t).attr('data-status')=='1'){$(t).attr('data-status',0);$(t).find('.iconfont').removeClass('icon-praise1').addClass('icon-praise');var count=parseInt($('.zan-count').html())-1;$.toast('点赞 -1');}else{$(t).attr('data-status',1);$(t).find('.iconfont').removeClass('icon-praise').addClass('icon-praise1');var count=parseInt($('.zan-count').html())+1;$.toast('点赞 +1');}
$('.zan-count').html(count);}}});});});$('.collect').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$('.action-bar').attr('data-url'),data:'type=2&status='+$(t).attr('data-status'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){if($(t).attr('data-status')=='1'){$(t).attr('data-status',0);$(t).find('.iconfont').removeClass('icon-fav1').addClass('icon-fav');$.toast('收藏 -1');}else{$(t).attr('data-status',1);$(t).find('.iconfont').removeClass('icon-fav').addClass('icon-fav1');$.toast('收藏 +1');}}}});});});$('.chat-btn').click(function(){var t=this;$.checkLogin(function(){$.ajax({url:$(t).attr('data-url'),data:'from_uid='+$(t).attr('data-from-uid')+'&chat='+1,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){window.location.href=res.data.url;}else{$.toast('聊天初始化失败，请稍后再试');}}});});});$('.status-btn').click(function(){var t=this;var text,status,tips;if($(t).html()=='已下架'){text='上架';status=1;tips='上架物品将会展示在列表中并且会收到关于该物品的聊天消息';}else{text='下架';status=-1;tips='下架物品将不会展示在列表中并且不会收到关于该物品的聊天消息';}
var buttons1=[{text:'请选择',label:true},{text:'已转让',color:'default',onClick:function(){$.confirm('转让物品后将不会收到聊天消息','确定该物品已转让?',function(){$.ajax({url:$(t).attr('data-url'),data:'status=2',dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){$.toast(res.errmsg);if(res.errno==0){$('.status-btn').html('已转让');}}});});}},{text:text,onClick:function(){$.confirm(tips,'确定要'+text+'该物品?',function(){$.ajax({url:$(t).attr('data-url'),data:'status='+status,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){$.toast(res.errmsg);if(res.errno==0){$('.status-btn').html('已'+text);}}});});}},{text:'编辑',onClick:function(){window.location.href=$(t).attr('data-edit-url');}},{text:'取消'}];var groups=[buttons1];$.actions(groups);});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_list",function(e,id,page){var type='default',lat='',lng='';$('.order-item',page).click(function(){var t=this;$(t).addClass('active').siblings().removeClass('active');$('.nodata',page).hide();type=$(t).attr('data-type');var data='page=1&op='+type;if(type=='location'){wx.getLocation({type:'gcj02',success:function(res){lat=res.latitude;lng=res.longitude;data+='&lat='+lat+'&lng='+lng;$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});},fail:function(res){console.log(res);}});}else{$.ajax({url:$('.content',page).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$('.content',page).attr('data-detail-url'),img_url:$('.content',page).attr('data-img-url'),};$('#goods-list',page).html('');loadItem(response,urls);$.refreshScroller();}}});}});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<div class="card facebook-card seller-item">';html+='<a href="'+param.url+'&id='+data[i]['id']+'" data-no-cache="true">';html+='<div class="card-header no-border">';html+='<div class="facebook-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='</div>';html+='<div class="facebook-info">';html+='<div class="facebook-name">'+data[i]['nickname']+'</div>';html+='<div class="facebook-date">'+data[i]['time_diff']+'前发布</div>';html+='</div>';if(data[i]['buy_type']==1){if(data[i]['credit']>0){html+='<div class="facebook-price">'+data[i]['credit']+'积分</div>';}else{html+='<div class="facebook-price">面议</div>';}}else{if(data[i]['price']>0){if(data[i]['unit']==1){html+='<div class="facebook-price">'+data[i]['price']+'美元</div>';}else{html+='<div class="facebook-price">'+data[i]['price']+'元</div>';}}else{html+='<div class="facebook-price">面议</div>';}}
html+='</div>';html+='<div class="card-content">';if(data[i]['status']==2){html+='<div class="sell-status">';html+='<img src="'+window.sysinfo.mobile_path+'images/yz.png">';html+='</div>';}
if(data[i]['album'].length==1){html+='<div class="img-box w50">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][0])+'">';html+='</div>';}else if(data[i]['album'].length>1){for(var j=0;j<data[i]['album'].length;j++){html+='<div class="img-box">';html+='<img class="card-photo" src="'+tomedia(data[i]['album'][j])+'">';html+='</div>';}}
html+='<p>'+data[i]['title']+'</p>';if(data[i]['comment']){html+='<div class="item-message">';html+='<p>'+data[i]['comment']['buyer_name']+'：'+data[i]['comment']['message']+'</p>';if(data[i]['comment']['reply']){html+='<p>主人回复：'+data[i]['comment']['reply']+'</p>';}
html+='</div>';}
html+='</div>';html+='<div class="card-footer">';html+='<div class="float-left">';html+='<div><i class="iconfont icon-pos"></i>'+data[i]['address']+'</div>';html+='</div>';html+='<div class="float-right">';html+='<div class="inline">';html+='<span class="iconfont icon-praise"></span><span>'+data[i]['zan']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-xiaoxi"></span><span>'+data[i]['message']+'</span>';html+='</div>';html+='<div class="inline">';html+='<span class="iconfont icon-eye"></span><span>'+data[i]['page_view']+'</span>';html+='</div>';html+='</div>';html+='</div>';html+='</a>';html+='</div>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;var data='page='+pageno+'&op='+type+'&lat='+lat+'&lng='+lng;$.ajax({url:$(t).attr('data-list-url'),data:data,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();$('.nodata',page).show();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_item_post",function(e,id,page){$('.post-book',page).click(function(){var buttons1=[{text:'请选择',label:true},{text:'扫码上传',onClick:function(){wx.scanQRCode({needResult:0,scanType:["barCode"],success:function(res){var result=res.resultStr;$('.html',page).html(result);}});}},{text:'手动上传',onClick:function(){$('.before-post',page).addClass('hide-item');$('.post-form',page).removeClass('hide-item');}}];var buttons2=[{text:'取消',bg:'danger'}];var groups=[buttons1,buttons2];$.actions(groups);});$('.post-other,.post-next',page).click(function(){$('.before-post',page).addClass('hide-item');$('.post-form',page).removeClass('hide-item');});$('.buy-type',page).change(function(){if($(this).val()==1){$('.credit_wrap',page).removeClass('hide-item');$('.cash_wrap',page).addClass('hide-item');}else{$('.credit_wrap',page).addClass('hide-item');$('.cash_wrap',page).removeClass('hide-item');}});var sp_list=$('.district').find('span');var dt_list=[];if(sp_list){for(var i=0;i<sp_list.length;i++){dt_list.push(sp_list.eq(i).html());}}
function getLonandLat(){wx.ready(function(){wx.getLocation({type:'gcj02',success:function(res){var lat=res.latitude;var lng=res.longitude;$('#latitude',page).val(lat);$('#longitude',page).val(lng);$.ajax({url:"https://apis.map.qq.com/ws/geocoder/v1/?location="+lat+","+lng+"&coord_type=5&get_poi=1&poi_options=address_format=short;radius=2000;policy=1;category=房产小区,住宅区,住宅小区&key=7M4BZ-FDEK3-JC737-YXQ5O-V3IO3-E5FH5&output=jsonp",type:"GET",dataType:'jsonp',success:function(data){var location=data.result.formatted_addresses.recommend;if(dt_list.length==0){$('input[name=address]',page).val(location);}else{var pois=data.result.pois;for(var i=0;i<dt_list.length;i++){for(var j=0;j<pois.length;j++){if(pois[j].title.match(dt_list[i])){$('input[name=address]',page).val(dt_list[i]);break;}}}
if($('input[name=address]',page).val()==''){$('input[name=address]',page).val(location);}}}});},cancel:function(){$.alert('打开地理位置以便获取您所在的小区',function(){getLonandLat();});}});});}
if(!$('.btn_post',page).attr('data-id')){getLonandLat();}
var album=[];if($('.item-img-wrap',page).find('img')){var img_list=$('.item-img-wrap',page).find('img');for(var i=0;i<img_list.length;i++){album.push(img_list.eq(i).attr('src'));}}
$('.add-img',page).off("click").on("click",function(){if(window.sysinfo.container=='wechat'){wx.chooseImage({count:9,sizeType:['original','compressed'],sourceType:['album','camera'],success:function(res){var localIds=res.localIds;for(let i=0;i<localIds.length;i++){var img="<img src='"+localIds[i]+"'>";$('.item-img-wrap',page).prepend(img);}
syncUpload(localIds);}});}else{$.toast('请在微信中上传图片');}});function syncUpload(localIds){var localId=localIds.pop();$('.item-img-wrap',page).prepend("<img src='"+localId+"'");wx.uploadImage({localId:localId,isShowProgressTips:0,success:function(res){var serverId=res.serverId;album.push(serverId);if(localIds.length>0){syncUpload(localIds);}else{$('#serverId',page).val(album);}}});}
$('.rule',page).click(function(){$.popup('.popup-rule');});window.addEventListener("resize",function(){if(document.activeElement.tagName=="INPUT"){window.setTimeout(function(){document.activeElement.scrollIntoViewIfNeeded();},0);}});$('.btn_post',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
$(t).addClass('disabled');var url=$(t).attr('data-url');var title=$('input[name=title]',page).val();var longitude=$('input[name=longitude]',page).val();var latitude=$('input[name=latitude]',page).val();var title=$('input[name=title]',page).val();var content=$('textarea[name=description]',page).val();var cid=$('select[name=category]',page).val();var price=$('input[name=price]',page).val();var address=$('input[name=address]',page).val();var token=$('input[name=token]',page).val();if(title==''){$.toast('请输入物品标题');$(t).removeClass('disabled');return false;}
if(album.length==0){$.toast('请上传物品图片');$(t).removeClass('disabled');return false;}
if(cid==0){$.toast('请选择物品分类');$(t).removeClass('disabled');return false;}
if(!$(t).attr('data-id')){if(!$('input[name=rule]').prop('checked')){$.toast('请先阅读物品发布公约');$(t).removeClass('disabled');return false;}}
$.ajax({type:'post',url:url,data:{'token':token,'id':$(t).attr('data-id'),'serverIds':album,'longitude':longitude,'latitude':latitude,'title':title,'description':content,'cid':cid,'address':address,'price':price,'submit':'yes'},dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){$.toast(resp.errmsg);if(resp.errno==0){if(resp.data.url){$.showIndicator();setTimeout(function(){window.location.href=resp.data.url;},2000);}}else{$(t).removeClass('disabled');}}})});});});;$(function(){'use strict';$(document).on('pageInit',".superpage_message",function(e,id,page){var chatPort=$(this).data('chatPort');window.ChatBox=window.ChatBox||{conn:null,client_id:'',init:function(){this.connect();},connect:function(){this.conn=new WebSocket("wss://"+document.domain+"/websocket");console.log(this.conn);this.conn.onopen=this.onopen;this.conn.onmessage=this.onmessage;this.conn.onclose=this.onclose;this.conn.onerror=this.onerror;},onopen:function(){console.log('ws connect open ...');if($('#message-list .chat-link',page).hasClass('disabled')){$('#message-list .chat-link',page).removeClass('disabled');}
var data={type:'login',sid:window.sysinfo.member.sid,uid:window.sysinfo.member.uid,nickname:window.sysinfo.member.nickname,};ChatBox.send(data);},onmessage:function(e){console.log('ws received message: '+e.data);var data=JSON.parse(e.data);switch(data['type']){case'ping':ChatBox.send({type:'pong'});break;case'say':ChatPage.message(data);break;case'logout':break;}},onclose:function(e){console.log("ws connect closed.");console.log(e);},onerror:function(e){console.error('ws error: '+e);$.alert('服务器连接失败，请稍后再试！');$('#message-list .chat-link',page).addClass('disabled');},send:function(data){if(!$.isString(data)){data=JSON.stringify(data);}
this.conn.send(data);console.log('ws sended message: '+data);}};ChatBox.init();document.addEventListener("visibilitychange",function(e){if(e.hidden){}
else{ChatBox.init();}});$('.chat-link',page).click(function(){var t=this;if($(t).hasClass('disabled')){return false;}
pushHistory();var url=$(t).data('url');$.ajax({url:url,dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(resp){if(resp.errno==0){$(t).data('active',1);$('.dot',t).hide();var tpl=$('#tpl_chat').html();var list=resp.data.message;if(list.length>0){for(var i=0;i<list.length;i++){list[i].message=explain(list[i].message);}}
var html=_.template(tpl)(resp.data);$('.popup-chat').html(html);$.popup('.popup-chat');ChatPage.init(page);}else{$.alert(resp.errno+':'+resp.errmsg);}}});});function explain(str){var reg=new RegExp(/\[[A-Z]*[\u4E00-\u9FA5]*\]/,'g');var list=window.emojis.qq.sources;var path=window.emojis.qq.path;return str.replace(reg,function(ss){for(var i=0;i<list.length;i++){var title='['+list[i].title+']';if(title==ss){return'<img src="'+path+list[i].url+'" />';}}});}
var ChatPage={init:function(page){ChatPage.refreshScroll();$('.txtMessage').unbind('keyup').keyup(function(e){if(e.keyCode!=13){return;}
$('.btnSend').trigger('click');});$('.btnSend').unbind('click').click(function(){var t=this;var itemid=$(this).data('itemid');var fromuid=$(this).data('fromuid');var message=$('.txtMessage');if(message.val()==''){$.toast('请输入消息');return false;}
if(message.val().length>=2048){$.toast('输入消息太长，请分开发送');return false;}
if($('.message_toolbar').css('bottom')!=0){$('.message_toolbar').css('bottom',0);$('.wrapper').hide();}
$.showIndicator();var data={type:'say',from_uid:window.sysinfo.member.uid,to_uid:fromuid,itemid:itemid,content:message.val(),};ChatBox.send(data);});$('#emoj').click(function(){$('.wrapper').show();$('.message_toolbar').css('bottom','161px');var text=document.querySelector(".txtMessage");var we=new wantEmoji({wrapper:".wrapper",row:3,callback:function(emojiCode){text.value+=emojiCode;text.focus();},autoInit:true});});$('.txtMessage').focus(function(){setTimeout(function(){window.scrollTo(0,$('body').height());},300);});$('.open-item-modal').click(function(){var img=$('.hide-item').find('img');var des=$('.hide-item .item-text').html();var html='';if(img.length>0){for(var i=0;i<img.length;i++){html+='<img src="'+img.eq(i).attr('src')+'">'}}
$.modal({title:'物品详情',text:'<div class="item-box">'+'<div class="img-list">'+html+'</div>'+'<div class="item-text">'+des+'</div>'+'</div>',buttons:[{text:'返回聊天',},]})});function loadMessage(data){var html='';if(data.message.length>0){for(var i=0;i<data.message.length;i++){if(data.message[i].from_uid==window.sysinfo.member.uid){html+='<div class="message-item float-left clearfix">';html+='<div class="message-avatar block">';html+='<img src="'+data.to.avatar+'">';html+='</div>';html+='<div class="message-box block">'+data.message[i].message+'</div>';html+='</div>';}else{html+='<div class="message-item float-right clearfix">';html+='<div class="message-avatar block">';html+='<img src="'+data.from.avatar+'">';html+='</div>';html+='<div class="message-box block">'+data.message[i].message+'</div>';html+='</div>';}}}else{html+='<div class="text-center color-gray font6 margin-bottom">没有更多了</div>';}
$('.message_list').prepend(html);}
$(document).on('refresh','.pull-to-refresh-content',function(e){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');var itemid=$(t).attr('data-itemid');var fromuid=$(t).attr('data-fromuid');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno+'&itemid='+itemid+'&fromuid='+fromuid,dataType:'json',success:function(resp){if(resp.data.message.length>0){$(t).attr('data-flag','0');loadMessage(resp.data);$(t).attr('data-page',pageno);$.pullToRefreshDone('.pull-to-refresh-content');$.refreshScroller();}else{$(t).attr('data-flag','1');loadMessage(resp.data);$.destroyPullToRefresh('.pull-to-refresh-content');$('.pull-to-refresh-layer').remove();}}});});},refreshScroll:function(){$.refreshScroller();$('.content').scrollTop($('.message_list').height()-$('.content').height());},message:function(data){var fromuid=$('.btnSend').data('fromuid');if(data.from_uid!=fromuid&&data.to_uid!=fromuid){$('.chat-link',page).each(function(){if($(this).data('active')){return true;}
if($(this).data('fromuid')==data.from_uid){$('.dot',this).show();$('.item-subtitle',this).html(data.content);return false;}});return;}
$.hideIndicator();$('.txtMessage').val('');var tpl=$('#tpl_message').html();var avatar,float;if(data.to_uid==window.sysinfo.member.uid){float='float-left';avatar=$('.pull-to-refresh-content').attr('data-from-avatar');}else{float='float-right';avatar=$('.pull-to-refresh-content').attr('data-avatar');}
var params={float:float,avatar:avatar,content:explain(data.content),};var html=_.template(tpl)(params);$('.message_list').append(html);ChatPage.refreshScroll();}};$('#message-list li').each(function(){if($(this).attr('data-from')){$(this).children('.chat-link').trigger('click');}});$('.hide-delete').click(function(){var t=this;$.confirm('确定要删除该条消息吗?',function(){$.ajax({url:$(t).attr('data-url'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('删除成功');window.location.reload();}else{$.toast('删除出错，请稍后重试');}}});});});function pushHistory(){var state={title:"title",url:"#"};window.history.pushState(state,"title","#");};window.onpopstate=function(){if($('.popup-chat').hasClass('modal-in')){$.closeModal('.popup-chat');}};function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<li>';html+='<a class="item-link item-content chat-link" data-url="'+param.url+'&itemid='+data[i]['itemid']+'" data-fromuid="'+data[i]['from_uid']+'" data-touid="'+data[i]['uid']+'" data-itemid="'+data[i]['itemid']+'" href="#">';html+='<div class="item-media block-avatar">';html+='<img src="'+data[i]['avatar']+'">';html+='<div class="dot"></div>';html+='</div>';html+='<div class="item-inner">';html+='<div class="item-title-row">';html+='<div class="item-title font75">'+data[i]['nickname']+'</div>';html+='</div>';html+='<div class="item-subtitle color-gray font65">'+data[i]['message']+'</div>';html+='<div class="item-img">';html+='<img src="'+param.img_url+data[i]['cover']+'" alt="">'
html+='</div>';html+='</div>';html+='</a>';html+='</li>';}
$('#message-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno,dataType:'json',success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();}}});});});});;$(function(){'use strict';$(document).on('pageInit',"#superpage_my_item_list",function(e,id,page){$('.hide-delete').click(function(){var t=this;$.confirm('确定要删除该物品吗?',function(){$.ajax({url:$(t).attr('data-url'),dataType:'json',beforeSend:function(){$.showIndicator();},complete:function(){$.hideIndicator();},success:function(res){if(res.errno==0){$.toast('删除成功');window.location.reload();}else{$.toast('删除出错，请稍后重试');}}});});});function loadItem(data,param){var html='';for(var i=0;i<data.length;i++){html+='<li>';html+='<a class="item-link item-content chat-link" data-no-cache="true" href="'+param.url+'&id='+data[i]['id']+'">';html+='<div class="item-media block-avatar">';html+='<img src="'+param.img_url+data[i]['cover']+'">';html+='</div>';html+='<div class="item-inner">';html+='<div class="item-title-row">';html+='<div class="item-title font75">'+data[i]['title']+'</div>';html+='</div>';html+='<div class="item-subtitle color-gray font65">'+data[i]['nickname']+'发表于'+data[i]['time_diff']+'前</div>';html+='</div>';html+='</a>';html+='</li>';}
$('#goods-list',page).append(html);}
$(page).on('infinite','.infinite-scroll',function(){var t=this;if($(t).attr('data-flag')=='1'){return;}
$(t).attr('data-flag','1');var pageno=$(t).attr('data-page');pageno=parseInt(pageno)+1;$.ajax({url:$(t).attr('data-list-url'),data:'page='+pageno,dataType:'json',success:function(response){$(t).attr('data-flag','0');if(response.length>0){var urls={url:$(t).attr('data-detail-url'),img_url:$(t).attr('data-img-url'),};loadItem(response,urls);$(t).attr('data-page',pageno);$.refreshScroller();}else{$.detachInfiniteScroll($('.infinite-scroll',page));$('.infinite-scroll-preloader',page).remove();}}});});});});;$(function(){'use strict';$(document).on('pageInit',".page",function(e,id,page){$.ajax({url:'./index.php?c=entry&do=stat&act=display&m=superman_hand2&i='+window.sysinfo.uniacid,success:function(response){console.log('stat display: ok');}});$('.lazyload').picLazyLoad({element:$('.content'),threshold:100});$('.external').each(function(){if($(this).attr('href')!=''){$(this).click(function(){$.showIndicator();});}});});$.init();});